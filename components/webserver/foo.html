<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IoTEmbeb</title>
    <style>
      body {
        padding: 16px;
      }

      h1 {
        font-size: 1.25rem;
      }

      .container {
        display: flex;
        gap: 16px;
      }

      .form-container {
        background-color: #cbd5e1;
        padding: 16px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
      }

      .log-container {
        background-color: #cbd5e1;
        padding: 16px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        overflow-y: scroll;
        height: 250px;
        margin-top: 16px;
      }

      .form-container input {
        margin-bottom: 8px;
      }

      .form-container button {
        padding: 8px;
        background-color: #3b82f6;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .form-container button:hover {
        background-color: #2563eb;
      }

      .save-button {
        padding: 8px;
        background-color: #10b981;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 16px;
      }

      .save-button:hover {
        background-color: #059669;
      }
    </style>
  </head>
  <body>
    <h1>IoT Embeb</h1>
    <div class="container">
      <form class="form-container">
        <h2>Network Config</h2>
        <input id="ssid" name="ssid" placeholder="ssid" />
        <input id="password" name="password" placeholder="password" type="password" />
        <button type="button" onclick="connectToSta()">Connect</button>
      </form>
      <form class="form-container">
        <h2>MQTT Config</h2>
        <input id="broker" name="broker" placeholder="broker" />
        <input id="topic" name="topic" placeholder="topic" />
        <button type="button" onclick="connectToMqtt()">Connect</button>
      </form>
      <form class="form-container">
        <h2>Commands</h2>
        <button type="button" onclick="sendCommand(0)">Play/Pausa</button>
        <button type="button" onclick="sendCommand(1)">Next</button>
        <button type="button" onclick="sendCommand(2)">Previous</button>
        <button type="button" onclick="sendCommand(3)">Stop</button>
        <button type="button" onclick="sendCommand(4)">Volume Up</button>
        <button type="button" onclick="sendCommand(5)">Volume Down</button>
      </form>
    </div>
    <button class="save-button" onclick="saveConfig()">Save</button>
    <div class="log-container">
      <button type="button" onclick="getLogs()">Refresh</button>
      <ul id="log-list"></ul>
    </div>
    <script>
      async function connectToSta() {
        const ssid = document.getElementById("ssid").value;
        const password = document.getElementById("password").value;

        const request = await fetch("/sta-connect", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ ssid, password }),
        });

        if (!request.ok) {
          console.error('Failed to connect to STA', await request.text());
        }
      }

      async function connectToMqtt() {
        const broker = document.getElementById("broker").value;
        const topic = document.getElementById("topic").value;

        const request = await fetch("/mqtt-connect", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ broker, topic }),
        });

        if (!request.ok) {
          console.error('Failed to connect to MQTT', await request.text());
        }
      }

      async function sendCommand(eventType) {
        const request = await fetch(`/event-type?event=${eventType}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        });

        if (!request.ok) {
          console.error('Failed to send command', await request.text());
        }
      }

      async function getLogs() {
        console.log("getLogs");
        const request = await fetch("/logs", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        });

        const logs = await request.json();
        const logList = document.getElementById("log-list");
        logList.innerHTML = "";
        logs?.buffer?.forEach((log) => {
          const li = document.createElement("li");
          li.textContent = JSON.stringify(log);
          logList.appendChild(li);
        });
      }

      async function loadConfig() {
        const response = await fetch('/config', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        });

        if (response.ok) {
          const config = await response.json();
          if (config.ssid) document.getElementById('ssid').value = config.ssid;
          if (config.password) document.getElementById('password').value = config.password;
          if (config.broker) document.getElementById('broker').value = config.broker;
          if (config.topic) document.getElementById('topic').value = config.topic;
        } else {
          console.error('Failed to load config', await response.text());
        }
      }

      async function saveConfig() {
        const ssid = document.getElementById("ssid").value;
        const password = document.getElementById("password").value;
        const broker = document.getElementById("broker").value;
        const topic = document.getElementById("topic").value;

        const configs = [
          { key: 'ssid', value: ssid },
          { key: 'password', value: password },
          { key: 'broker', value: broker },
          { key: 'topic', value: topic }
        ];

        for (const config of configs) {
          const request = await fetch('/config', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(config),
          });

          if (!request.ok) {
            console.error(`Failed to save config for ${config.key}`, await request.text());
          }
        }
      }

      document.addEventListener('DOMContentLoaded', loadConfig);
    </script>
  </body>
</html>
